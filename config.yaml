# ============================================================================
# COPD 数字孪生肺项目 - 全局配置文件
# ============================================================================

# ----- 路径配置 -----
paths:
  data_root: "data"
  raw_data: "data/00_raw"
  cleaned_data: "data/01_cleaned"
  atlas: "data/02_atlas"
  mapped: "data/03_mapped"
  final_viz: "data/04_final_viz"
  checkpoints: "checkpoints"
  logs: "logs"

# ----- 文件命名规范 -----
naming:
  # 格式: {type}_{patient_id:03d}.nii.gz
  # 示例: normal_001.nii.gz, copd_001.nii.gz
  pattern: "{type}_{patient_id:03d}.nii.gz"
  mask_suffix: "_mask"
  lesion_suffix: "_lesion"

# ----- 数据格式约定 -----
data_format:
  # NIfTI 规范
  nifti:
    dtype: "float32"
    affine_unit: "mm"
  
  # CT 值范围
  ct:
    min_hu: -1024
    max_hu: 3071
    background_hu: -1000
    air_hu: -1000
    water_hu: 0
  
  # Mask 规范
  mask:
    dtype: "uint8"
    background: 0
    foreground: 1

# ----- 预处理参数 -----
preprocessing:
  # 肺部分割配置 (2025-12-09 更新)
  segmentation:
    # 分割方法: auto, totalsegmentator, threshold
    # - auto: 自动选择（优先 TotalSegmentator GPU，回退到 threshold）
    # - totalsegmentator: 深度学习方法（高精度，需 GPU 和 TotalSegmentator 安装）
    # - threshold: 阈值方法（轻量 CPU，用于无 GPU 环境）
    method: "auto"

    # 设备配置: gpu, cpu, cuda:0, cuda:1 等
    device: "gpu"

    # TotalSegmentator 特定参数
    totalsegmentator:
      task: "lung"               # 分割任务类型
      fast_mode: false           # 快速模式（精度略低，速度快 5 倍）
      roi_subset:                # 分割的肺叶子集
        - "lung_upper_lobe_left"
        - "lung_lower_lobe_left"
        - "lung_upper_lobe_right"
        - "lung_middle_lobe_right"
        - "lung_lower_lobe_right"

      # 气管树分割 (2025-12-22 新增)
      extract_trachea: true      # 是否提取气管树 mask
      trachea_structures:        # 气管相关结构
        - "trachea"

      # 肺叶精细标记 (2025-12-22 新增)
      create_labeled_lobes: true # 是否创建带标签的肺叶 mask
      lobe_labels:               # 肺叶标签定义
        lung_upper_lobe_left: 1    # 左上叶
        lung_lower_lobe_left: 2    # 左下叶
        lung_upper_lobe_right: 3   # 右上叶
        lung_middle_lobe_right: 4  # 右中叶
        lung_lower_lobe_right: 5   # 右下叶

    # 阈值方法参数
    threshold:
      lower_hu: -1000            # 下限阈值 (HU)
      upper_hu: -300             # 上限阈值 (HU)
      min_lung_size: 500000      # 最小肺体积（体素数）
      max_lung_ratio: 0.40       # 肺最大占比（相对于整个 CT）
      min_lung_ratio: 0.03       # 肺最小占比

    # 输出配置
    output:
      background_hu: -1000       # 背景填充 HU 值
      mask_dtype: "uint8"        # mask 数据类型

  # LAA-950 病灶提取（优化参数 2025-12-04）
  laa950:
    threshold: -950  # HU 阈值
    min_volume_mm3: 100  # 最小体素体积（增加以过滤噪声，原值 10）
    apply_morphology: true  # 是否应用形态学清理
    opening_radius: 1  # opening 操作半径（去除小突起）
    closing_radius: 2  # closing 操作半径（填充小空洞）

  # 数据质量检查
  quality_check:
    min_slices: 100
    max_slice_thickness_mm: 3.0
    min_hu: -1100
    max_hu: -200
    min_lung_volume_ratio: 0.1

# ----- 配准参数 (ANTsPy) -----
registration:
  # 模板构建
  template_build:
    type_of_transform: "SyN"
    iteration_limit: 5
    gradient_step: 0.2
  
  # 病灶配准
  lesion_registration:
    type_of_transform: "SyNRA"
    reg_iterations: [100, 70, 50, 20]
    shrink_factors: [8, 4, 2, 1]
    smoothing_sigmas: [3, 2, 1, 0]

# ----- 训练参数 -----
training:
  # 数据加载
  batch_size: 4
  num_workers: 4
  patch_size: [64, 64, 64]
  
  # 优化器
  optimizer: "Adam"
  learning_rate: 0.0002
  beta1: 0.5
  beta2: 0.999
  weight_decay: 0.0001
  
  # 损失函数权重
  loss_weights:
    reconstruction: 1.0
    perceptual: 0.1
    adversarial: 0.01
  
  # 训练控制
  epochs: 100
  save_frequency: 10
  validate_frequency: 5
  early_stopping_patience: 20

# ----- 评估参数 -----
evaluation:
  metrics:
    - "SSIM"
    - "PSNR"
    - "MSE"
    - "Dice"
    - "HD95"
  
  # 合格阈值
  thresholds:
    ssim_min: 0.85
    psnr_min: 25.0
    dice_min: 0.85
    hd95_max: 10.0

# ----- 可视化参数 -----
visualization:
  # 体渲染参数（优化参数 2025-12-04）
  volume_rendering:
    lung_opacity: 0.25  # 降低透明度，让肺更"透"（原值 0.3）
    lesion_opacity: 0.9  # 提高病灶不透明度，更突出（原值 0.8）
    lung_color: [0.8, 0.8, 0.8]  # 更浅的灰色（原值 0.7）
    lesion_color: [0.9, 0.1, 0.1]  # 更鲜艳的红色
    lung_threshold: -500  # 肺组织等值面 HU 阈值
  
  # 呼吸动画参数
  breathing:
    frequency_hz: 0.25  # 呼吸频率
    amplitude: 0.1      # 形变幅度
    copd_delay: 0.3     # COPD 呼气延迟
    fps: 30
    duration_sec: 8
  
  # 输出设置
  output:
    image_resolution: [1920, 1080]
    video_codec: "libx264"
    image_format: "png"

