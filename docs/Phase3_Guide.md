# Phase 3 å®æ–½æŒ‡å—ï¼šç—…ç†ç‰¹å¾æ˜ å°„ä¸ AI èåˆ

**è¯¾é¢˜åç§°**ï¼šåŸºäºå…¨ä»£ç è‡ªåŠ¨åŒ–çš„ COPD æ•°å­—å­ªç”Ÿè‚ºæ„å»ºä¸ 3D å¯è§†åŒ–ç ”ç©¶
**é€‚ç”¨é˜¶æ®µ**ï¼šPhase 3 (Pathology Mapping & Hybrid Fusion)
**æ ¸å¿ƒèŒƒå¼**ï¼šå®è§‚ç©ºé—´é…å‡† (ANTsPy) + å¾®è§‚çº¹ç†åˆæˆ (Generative AI)
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.1 (Based on Engineering Edition v6.3 & v5_1_Final.md)
**æ›´æ–°æ—¥æœŸ**ï¼š2025-12-30

---

## 1. æ€»ä½“æ¶æ„ä¸é€»è¾‘

æœ¬é˜¶æ®µæ—¨åœ¨è§£å†³"å¦‚ä½•å°†çœŸå®çš„ COPD ç—…ç†ç‰¹å¾é€¼çœŸåœ°è¿ç§»åˆ°æ ‡å‡†æ•°å­—å­ªç”Ÿåº•åº§ä¸Š"è¿™ä¸€æ ¸å¿ƒéš¾é¢˜ã€‚

**æ ¸å¿ƒé€»è¾‘**ï¼š

1. **å®è§‚å¯¹é½ (Macro-Alignment)**ï¼šåˆ©ç”¨ **ANTsPy** è®¡ç®—æ‚£è€…è‚ºéƒ¨åˆ°æ ‡å‡†åº•åº§çš„å˜å½¢åœºï¼Œå°†ç—…ç¶ Mask ç²¾ç¡®"æ¬è¿"åˆ°æ ‡å‡†è‚ºçš„æ­£ç¡®è§£å‰–ä½ç½®ã€‚
2. **å¾®è§‚ç¼åˆ (Micro-Synthesis)**ï¼šåˆ©ç”¨ **æ·±åº¦å­¦ä¹  (Inpainting/GAN)** åœ¨æ ‡å‡†è‚ºçš„å¯¹åº”ä½ç½®"æŒ–ç©º"å¹¶é‡æ–°ç”Ÿæˆï¼Œä¿®å¤å› ç›´æ¥ç²˜è´´å¯¼è‡´çš„è¾¹ç¼˜ç”Ÿç¡¬å’Œè¡€ç®¡æˆªæ–­é—®é¢˜ã€‚

### 1.1 æ•°æ®æµå›¾ (Data Flow)

```mermaid
graph TD
    Atlas[æ ‡å‡†åº•åº§ Atlas]
    Patient[COPD æ‚£è€… CT]
    Lesion[ç—…ç¶ Mask]

    subgraph Phase3A[Phase 3A: ç©ºé—´æ˜ å°„]
    Patient -->|Moving| Reg(ANTsPy SyN é…å‡†)
    Atlas -->|Fixed| Reg
    Reg -->|å˜å½¢åœº Warp| Apply(Apply Transforms)
    Lesion -->|Moving Mask| Apply
    Apply -->|NearestNeighbor| MappedMask[æ ‡å‡†ç©ºé—´ä¸‹çš„ç—…ç¶ Mask]
    end

    subgraph Phase3B[Phase 3B: AI çº¹ç†èåˆ]
    Atlas -->|Input| Crop(Patch è£å‰ª)
    Patient -->|Input| Crop
    Crop -->|Training Data| Train(è®­ç»ƒ Inpainting æ¨¡å‹)
    Atlas -->|Target| Fuse(æŒ–ç©ºä¸ç”Ÿæˆ)
    MappedMask -->|Region| Fuse
    Train -->|Model Weights| Fuse
    Fuse -->|Poisson Blending| Final[æœ€ç»ˆæ•°å­—å­ªç”Ÿ CT]
    end
```

---

## 2. è¯¦ç»†å®æ–½æ­¥éª¤ (Step-by-Step Implementation)

### å­é˜¶æ®µ 3.1ï¼šå®è§‚ç©ºé—´æ˜ å°„ (Macro Spatial Mapping)

**ç›®æ ‡**ï¼šè®¡ç®—å˜å½¢åœºï¼Œå°† COPD ç—…ç¶ Mask æ‰­æ›²åˆ°æ ‡å‡†åº•åº§ç©ºé—´ã€‚

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **å¯¹åº”è„šæœ¬** | `src/03_registration/register_lesions.py` |
| **é¢„è®¡è€—æ—¶** | 1-2 å¤©ï¼ˆç¼–å†™ï¼‰+ æ¯ä¾‹çº¦ 5-10 åˆ†é’Ÿï¼ˆè¿è¡Œï¼‰ |

**è¾“å…¥æ•°æ®**ï¼š
- Fixed Image: `data/02_atlas/standard_template.nii.gz` (CT æ¨¡æ¿)
- Fixed Mask: `data/02_atlas/standard_mask.nii.gz` (è‚ºéƒ¨ maskï¼Œç”¨äºçº¦æŸ)
- Moving Image: `data/01_cleaned/copd_clean/*.nii.gz` (æ‚£è€… CT)
- Moving Mask: `data/01_cleaned/copd_emphysema/*.nii.gz` (ç—…ç¶ mask)
- **æ•°å­—è‚ºåº•åº§** (å¯é€‰): `data/02_atlas/digital_lung_labels.nii.gz` (èåˆæ ‡ç­¾ï¼Œç”¨äºå¯è§†åŒ–)

> **æ³¨**: æ•°å­—è‚ºåº•åº§å°†è‚ºå¶æ ‡ç­¾(1-5)å’Œæ°”ç®¡æ ‘(6)åˆå¹¶ä¸ºå•ä¸€æ–‡ä»¶ï¼Œç®€åŒ–å¯è§†åŒ–æµç¨‹ã€‚è¯¦è§ [`docs/digital_lung_base.md`](digital_lung_base.md)

**æŠ€æœ¯ç»†èŠ‚**ï¼š
1. **é…å‡†ç®—æ³•**ï¼šä½¿ç”¨ SyN (Symmetric Normalization)ï¼Œå¾®åˆ†åŒèƒšé…å‡†ï¼Œä¿è¯å¤§å˜å½¢ä¸‹çš„æ‹“æ‰‘ç»“æ„ã€‚
2. **æ’å€¼ç­–ç•¥**ï¼š
   - CT å›¾åƒï¼šLinear æˆ– BSpline æ’å€¼
   - **ç—…ç¶ Maskï¼šå¿…é¡»ä½¿ç”¨ NearestNeighbor æˆ– GenericLabel**

**è¾“å‡ºäº§ç‰©**ï¼š
- `data/03_mapped/{patient_id}/warped_lesion.nii.gz`
- `data/03_mapped/{patient_id}/warped_ct.nii.gz`
- `data/03_mapped/{patient_id}/transform*.mat`

---

### å­é˜¶æ®µ 3.2ï¼šPatch æ•°æ®é›†æ„å»º (Dataset Construction)

**ç›®æ ‡**ï¼šä»åŸå§‹ CT ä¸­æå–è®­ç»ƒç”¨çš„å›¾åƒå—ï¼ˆPatchï¼‰ã€‚

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **å¯¹åº”è„šæœ¬** | `src/04_texture_synthesis/dataset.py` |
| **é¢„è®¡è€—æ—¶** | 3-5 å¤© |

**Patch å°ºå¯¸é€‰æ‹©**ï¼š
- æ¨èï¼š64Ã—64Ã—64 ä½“ç´ 
- å¯é€‰ï¼š128Ã—128Ã—128 ä½“ç´ ï¼ˆæ•ˆæœæ›´å¥½ï¼Œæ˜¾å­˜éœ€æ±‚æ›´é«˜ï¼‰

**æ•°æ®å¢å¼º**ï¼šéšæœºç¿»è½¬ã€éšæœºæ—‹è½¬ã€å¼¹æ€§å˜å½¢ã€é«˜æ–¯å™ªå£°ã€å¼ºåº¦ç¼©æ”¾

---

### å­é˜¶æ®µ 3.3ï¼šçº¹ç†ç”Ÿæˆç½‘ç»œè®­ç»ƒ (Model Training)

**ç›®æ ‡**ï¼šè®­ç»ƒ Inpainting æ¨¡å‹ã€‚

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **å¯¹åº”è„šæœ¬** | `run_phase3b_training.py`, `src/04_texture_synthesis/train.py` |
| **é¢„è®¡è€—æ—¶** | 7-14 å¤©ï¼ˆå«è°ƒå‚ï¼‰ |

**æ¨¡å‹æ¶æ„é€‰å‹**ï¼š
1. **åŸºçº¿æ–¹æ¡ˆ**ï¼š3D U-Net Inpaintingï¼ˆæ¨èé¦–é€‰ï¼Œå·²å®ç°ï¼‰
2. **è¿›é˜¶æ–¹æ¡ˆ**ï¼š3D Partial Convolution Network
3. **é«˜çº§æ–¹æ¡ˆ**ï¼š3D Patch-GAN + Perceptual Loss

**æŸå¤±å‡½æ•°**ï¼šL1 Loss + Perceptual Loss + Adversarial Lossï¼ˆå¯é€‰ï¼‰

**å¿«é€Ÿå¼€å§‹**ï¼š
```bash
# åŸºç¡€è®­ç»ƒï¼ˆä»… U-Netï¼Œæ—  GANï¼‰
python run_phase3b_training.py --no-gan --epochs 50

# å®Œæ•´è®­ç»ƒï¼ˆU-Net + GANï¼‰
python run_phase3b_training.py --epochs 100

# ä»æ£€æŸ¥ç‚¹æ¢å¤
python run_phase3b_training.py --resume checkpoints/latest.pth
```

---

### å­é˜¶æ®µ 3.4ï¼šæ¨ç†ä¸åå¤„ç†

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **å¯¹åº”è„šæœ¬** | `run_phase3b_inference.py`, `src/04_texture_synthesis/inference_fuse.py` |
| **é¢„è®¡è€—æ—¶** | æ¯ä¾‹çº¦ 1-2 åˆ†é’Ÿ |

**æ¨ç†æµç¨‹**ï¼šæŒ–ç©º â†’ åˆ†å—æ¨ç† â†’ æ‹¼æ¥ â†’ è¾¹ç•Œå¹³æ»‘

**å¿«é€Ÿå¼€å§‹**ï¼š
```bash
# æ‰¹é‡æ¨ç†æ‰€æœ‰æ‚£è€…
python run_phase3b_inference.py

# æŒ‡å®šå•ä¸ªæ‚£è€…
python run_phase3b_inference.py --patient copd_001

# ä½¿ç”¨æŒ‡å®šæ£€æŸ¥ç‚¹
python run_phase3b_inference.py --checkpoint checkpoints/epoch_50.pth
```

**è¾“å‡º**ï¼š`data/04_final_viz/{patient_id}_fused.nii.gz`

---

### å­é˜¶æ®µ 3.5ï¼šæ•ˆæœè¯„ä¼°ä¸è¿­ä»£

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **å¯¹åº”è„šæœ¬** | `src/utils/metrics.py` |
| **é¢„è®¡è€—æ—¶** | 3-5 å¤© |

**è¯„ä¼°æŒ‡æ ‡**ï¼šSSIM â‰¥ 0.85, PSNR â‰¥ 25 dB, è¾¹ç•Œæ— æ˜æ˜¾æ–­è£‚

---

## 3. å·¥ç¨‹ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ 03_registration/              # [Phase 3A] ç©ºé—´æ˜ å°„
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ register_lesions.py
â”‚   â””â”€â”€ warp_utils.py
â”‚
â””â”€â”€ 04_texture_synthesis/         # [Phase 3B] AI çº¹ç†èåˆ
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ dataset.py
    â”œâ”€â”€ network.py
    â”œâ”€â”€ losses.py
    â”œâ”€â”€ train.py
    â””â”€â”€ inference_fuse.py
```

---

## 4. é¢„è®¡å·¥æœŸæ€»è§ˆ

| å­é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡è€—æ—¶ |
|--------|------|----------|
| 3.1 | å®è§‚ç©ºé—´æ˜ å°„ | 1-2 å¤© |
| 3.2 | Patch æ•°æ®é›†æ„å»º | 3-5 å¤© |
| 3.3 | æ¨¡å‹æ¶æ„ä¸è®­ç»ƒ | 7-14 å¤© |
| 3.4 | æ¨ç†ä¸åå¤„ç† | 2-3 å¤© |
| 3.5 | æ•ˆæœè¯„ä¼°ä¸è¿­ä»£ | 3-5 å¤© |
| **æ€»è®¡** | | **16-29 å¤©** |

---

## 5. ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®

### ç«‹å³æ‰§è¡Œ

ç¼–å†™å¹¶è¿è¡Œ `src/03_registration/register_lesions.py`

- **åŸå› **ï¼šåªæœ‰å…ˆå®Œæˆå®è§‚ç©ºé—´æ˜ å°„ï¼Œæ‹¿åˆ° `warped_lesion.nii.gz`ï¼Œåç»­ AI èåˆæ‰æœ‰ç›®æ ‡åŒºåŸŸã€‚
- **éªŒæ”¶æ ‡å‡†**ï¼šç—…ç¶ä½ç½®åå·® â‰¤ 5mm

### ä¾èµ–æ¡ä»¶

| å‰ç½®æ¡ä»¶ | çŠ¶æ€ |
|----------|------|
| Phase 2 æ ‡å‡†åº•åº§ | âœ… å·²å®Œæˆ |
| æ°”ç®¡æ ‘æ¨¡æ¿ | âœ… å·²å®Œæˆ |
| 5 è‚ºå¶æ ‡ç­¾ | âœ… å·²å®Œæˆ |
| COPD æ•°æ®å‡†å¤‡ | ğŸš§ å¾…ç¡®è®¤ï¼ˆéœ€ 30-50 ä¾‹ï¼‰ |

---

## 6. å†…å­˜ç®¡ç†ä¸æ•…éšœæ’é™¤

### 6.1 å¸¸è§é—®é¢˜ï¼šå†…å­˜åˆ†é…å¤±è´¥

**ç—‡çŠ¶**ï¼š
```
Exception caught:
itk::MemoryAllocationError (000000729D1E7650)
Location: "unknown"
File: ...\itkImportImageContainer.hxx
Line: 191
Description: Failed to allocate memory for image.
```

**åŸå› **ï¼š
- ANTsPy SyN é…å‡†éœ€è¦å¤§é‡å†…å­˜ï¼ˆæ¯ä¾‹çº¦ 4-6 GBï¼‰
- è¿ç»­å¤„ç†å¤šä¸ªæ‚£è€…æ—¶ï¼Œå†…å­˜æ²¡æœ‰åŠæ—¶é‡Šæ”¾å¯¼è‡´ç´¯ç§¯
- ç³»ç»Ÿå¯ç”¨å†…å­˜ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **è‡ªåŠ¨å†…å­˜æ¸…ç†**ï¼ˆå·²å®ç°ï¼‰ï¼š
   - `run_phase3_pipeline.py` åœ¨æ¯ä¸ªæ‚£è€…é…å‡†åè°ƒç”¨ `gc.collect()`
   - `register_lesions.py` åœ¨é…å‡†å‡½æ•°å†…éƒ¨é‡Šæ”¾å¤§å‹å¯¹è±¡

2. **é™ä½é…å‡†å‚æ•°**ï¼ˆå¯é€‰ï¼‰ï¼š
   ä¿®æ”¹ `config.yaml` ä¸­çš„é…å‡†è¿­ä»£æ¬¡æ•°ï¼š
   ```yaml
   lesion_registration:
     # åŸå§‹å‚æ•°ï¼ˆé«˜ç²¾åº¦ï¼Œé«˜å†…å­˜ï¼‰
     # reg_iterations: [100, 70, 50, 20]

     # é™ä½åçš„å‚æ•°ï¼ˆè¾ƒä½å†…å­˜å ç”¨ï¼‰
     reg_iterations: [50, 30, 20, 10]
   ```

3. **åˆ†æ‰¹å¤„ç†**ï¼š
   ä½¿ç”¨ `--limit` å‚æ•°åˆ†æ‰¹å¤„ç†æ‚£è€…ï¼š
   ```bash
   # æ¯æ‰¹å¤„ç† 10 ä¾‹
   python run_phase3_pipeline.py --limit 10
   ```

4. **ç›‘æ§å†…å­˜ä½¿ç”¨**ï¼š
   ```bash
   # Windows: ä½¿ç”¨ä»»åŠ¡ç®¡ç†å™¨ç›‘æ§ Python è¿›ç¨‹å†…å­˜
   # Linux: ä½¿ç”¨ htop æˆ– free -h
   ```

### 6.2 é…å‡†å‚æ•°è°ƒä¼˜

| å‚æ•° | é»˜è®¤å€¼ | ä½å†…å­˜å€¼ | è¯´æ˜ |
|------|--------|----------|------|
| `reg_iterations` | [100, 70, 50, 20] | [50, 30, 20, 10] | æ¯çº§è¿­ä»£æ¬¡æ•° |
| `shrink_factors` | [8, 4, 2, 1] | [8, 4, 2, 1] | å¤šåˆ†è¾¨ç‡ç¼©æ”¾ |
| `smoothing_sigmas` | [3, 2, 1, 0] | [3, 2, 1, 0] | å¹³æ»‘å‚æ•° |

**æ³¨æ„**ï¼šé™ä½ `reg_iterations` ä¼šå‡å°‘é…å‡†ç²¾åº¦ï¼Œä½†å¯æ˜¾è‘—é™ä½å†…å­˜å ç”¨å’Œå¤„ç†æ—¶é—´ã€‚

### 6.3 å…¶ä»–æ•…éšœæ’é™¤

| é—®é¢˜ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|----------|----------|
| é…å‡†è¶…æ—¶ | å›¾åƒå°ºå¯¸è¿‡å¤§ | æ£€æŸ¥ CT å±‚æ•°ï¼Œè€ƒè™‘ä¸‹é‡‡æ · |
| ç—…ç¶ä¸¢å¤± | æ’å€¼æ–¹æ³•é”™è¯¯ | ç¡®ä¿ä½¿ç”¨ `genericLabel` æ’å€¼ |
| å˜å½¢è¿‡å¤§ | æ‚£è€…ä¸æ¨¡æ¿å·®å¼‚å¤§ | æ£€æŸ¥ CT è´¨é‡ï¼Œè€ƒè™‘æ’é™¤å¼‚å¸¸æ¡ˆä¾‹ |
