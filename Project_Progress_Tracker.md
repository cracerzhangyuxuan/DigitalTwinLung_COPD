# COPD 数字孪生肺项目 - 进度追踪文档

**更新日期：** 2025年12月9日
**项目名称：** 基于全代码自动化的COPD数字孪生肺构建与3D可视化研究

---

## 进度图例

| 标记 | 含义 |
|:----:|:-----|
| `[ ]` | 未开始 (Not Started) |
| `[~]` | 进行中 (In Progress) |
| `[x]` | 已完成 (Completed) |

---

## 一、项目分阶段执行流程图

```
================================================================================
              COPD 数字孪生肺项目 - 分阶段执行流程图 (带进度追踪)
================================================================================

+------------------------------------------------------------------------------+
| [x] PHASE 1: MVP - 基础设施与最小闭环 ✅ 完成于 2025-12-09                   |
+------------------------------------------------------------------------------+
| 目标: 用极少数据跑通完整流程，验证开发环境                                   |
| 输入: 3例正常肺 + 1例COPD                                                    |
|                                                                              |
| 任务流程:                                                                    |
|   [x] 环境配置 -> [x] 数据清洗 -> [x] 简单配准 -> [x] 可视化验证             |
|       Python3.9+     run_segment    选1例正常肺    static_render.py          |
|       PyTorch        clean_bg.py    作临时底座    render_multiview()         |
|       ANTsPy         precise_lung   register.py                              |
|                                                                              |
| 输出: 9张多视角3D渲染截图 (模板/原始/配准后 × X/Y/Z轴)                       |
| 验收: [x] 灰色肺 + 红色病灶清晰可见  [x] 配准保留率81%                       |
+------------------------------------------------------------------------------+
                                      |
                                      v
+------------------------------------------------------------------------------+
| [ ] PHASE 2: Atlas Construction - 标准底座构建                               |
+------------------------------------------------------------------------------+
| 目标: 生成高质量数字孪生底座                                                 |
| 输入: 15-20例正常肺CT                                                        |
|                                                                              |
| 任务流程:                                                                    |
|   [ ] 数据扩充 -> [ ] 构建模版 -> [ ] 结果固化                               |
|       收集正常肺    build_template_ants.py    存入 data/02_atlas/            |
|                     (运行约一整夜)                                           |
|                                                                              |
| 输出: standard_template.nii.gz, standard_mask.nii.gz                         |
| 验收: [ ] Dice>=0.85  [ ] 血管/气管结构清晰                                  |
+------------------------------------------------------------------------------+
                                      |
                                      v
+------------------------------------------------------------------------------+
| [ ] PHASE 3: Mapping & AI Fusion - 病理映射与AI融合                          |
+------------------------------------------------------------------------------+
| 目标: 批量处理COPD，训练AI，生成融合CT                                       |
| 输入: 30-50例COPD + 标准底座                                                 |
|                                                                              |
| 任务流程:                                                                    |
|   [ ] 批量映射 -> [ ] AI训练(20-34天) -> [ ] 最终融合                        |
|       配准所有COPD   |                    inference_fuse.py                 |
|       病灶扭曲到     +-> [ ] Patch构建(3-5d)  底座+Mask->挖空->AI填          |
|       标准空间       +-> [ ] 模型实现(5-7d)                                  |
|                      +-> [ ] 训练调参(7-14d)                                 |
|                      +-> [ ] 推理后处理(2-3d)                                |
|                      +-> [ ] 评估迭代(3-5d)                                  |
|                                                                              |
| 输出: fused_copd_twin.nii.gz, mapped_lesion_mask.nii.gz                      |
| 验收: [ ] SSIM>=0.85  [ ] 边界无断裂  [ ] Loss收敛                           |
+------------------------------------------------------------------------------+
                                      |
                                      v
+------------------------------------------------------------------------------+
| [ ] PHASE 4: Final Demo - 全代码交互演示                                     |
+------------------------------------------------------------------------------+
| 目标: 产出论文图片和答辩视频                                                 |
| 输入: 融合CT + 病灶Mask                                                      |
|                                                                              |
| 任务流程:                                                                    |
|   [ ] 动态模拟 -> [ ] 成果输出                                               |
|       dynamic_breath.py    录制视频.mp4                                      |
|       sin(t)形变           截取高清图>=3张                                   |
|       COPD呼气延迟         生成GIF动画                                       |
|                                                                              |
| 输出: demo_video.mp4, figure_1~n.png                                         |
| 验收: [ ] 帧率>=15FPS  [ ] 呼吸周期可区分  [ ] 病灶高亮                       |
+------------------------------------------------------------------------------+
                                      |
                                      v
                            [ ] 项目完成! 论文/答辩
```

---

## 二、项目整体技术架构图

```
================================================================================
                COPD 数字孪生肺项目 - 技术架构总览
================================================================================

[技术栈] ======================================================================
+------------------+------------------+------------------+------------------+
| TotalSegmentator |     ANTsPy       |     PyTorch      |     PyVista      |
| 自动肺部分割     | SyN非线性配准    | U-Net/GAN        | VTK体渲染        |
| 多器官提取       | 模板构建         | Inpainting       | 动态动画         |
+--------+---------+--------+---------+--------+---------+--------+---------+
         |                  |                  |                  |
         v                  v                  v                  v
[代码层 src/] =================================================================
+----------------+----------------+----------------+----------------+----------------+
|01_preprocess/  |02_atlas_build/ |03_registration/|04_texture_syn/ |05_visualization|
|----------------|----------------|----------------|----------------|----------------|
|run_segment.py  |build_template_ |register_       |dataset.py      |static_render.py|
|clean_bg.py     |ants.py         |lesions.py      |network.py      |dynamic_breath. |
|extract_emphy.py|                |                |losses.py       |py              |
|                |                |                |train.py        |                |
|                |                |                |inference_fuse. |                |
+-------+--------+-------+--------+-------+--------+-------+--------+-------+--------+
        |                |                |                |                |
        +----------------+----------------+----------------+----------------+
                                          |
                                          v
                    +--------------------------------------------------------------+
                    |                  src/utils/ 工具层                          |
                    |--------------------------------------------------------------|
                    | io.py | logger.py | metrics.py | data_quality.py | validation.py |
                    | NIfTI | 统一日志  | SSIM/Dice  | 输入数据检查    | 配准验证      |
                    +--------------------------------------------------------------+
                                          |
                                          v
[数据层 data/] ================================================================
+-------------+     +-------------+     +-------------+     +-------------+     +-------------+
|  00_raw/    | --> | 01_cleaned/ | --> |  02_atlas/  |     |  03_mapped/ | --> |04_final_viz/|
|-------------|     |-------------|     |-------------|     |-------------|     |-------------|
| normal/     |     | normal_clean|     | standard_   |     | patient_xxx/|     | fused_copd_ |
| copd/       |     | copd_clean/ |     | template.   | --> | warped.nii  |     | twin.nii.gz |
| (DICOM/NIfTI|     |             |     | nii.gz      |     | transform.  |     | renders/    |
|  只读)      |     |             |     | mask.nii.gz |     | mat         |     |  fig_*.png  |
+-------------+     +-------------+     +------+------+     +-------------+     +-------------+
                                               |                   ^
                                               +-------------------+

[数据流] ======================================================================

原始CT    纯净肺     标准底座    映射病灶    融合CT     3D演示
(DICOM)   (NIfTI)   (Template)  (Warped)   (Fused)    (Video)
   |         |          |          |          |          |
   +----+----+----+-----+----+-----+----+-----+----+-----+
        |         |          |          |          |
        v         v          v          v          v
   [TotalSeg] [ANTsPy]   [ANTsPy]  [PyTorch]  [PyVista]
   [背景置换] [build]    [SyN配准] [Inpaint]  [Render]

[辅助组件] ====================================================================
+---------------+---------------+---------------+---------------+
| checkpoints/  |    logs/      |    tests/     |  notebooks/   |
|---------------|---------------|---------------|---------------|
| best.pth      | pipeline.log  | test_io.py    | check_data.   |
| latest.pth    | training.log  | test_metrics  | test_ants.    |
| train_log.json| preprocess.log| conftest.py   | viz_demo.ipynb|
+---------------+---------------+---------------+---------------+

[配置文件 config.yaml] ========================================================
+------------------------------------------------------------------------------+
| paths:         数据目录路径      | training:    批次/学习率/损失权重          |
| naming:        文件命名规范      | evaluation:  SSIM/Dice/PSNR阈值            |
| data_format:   NIfTI/CT/Mask约定 | visualization: 颜色/透明度/呼吸参数        |
| preprocessing: 分割/LAA阈值     | registration: SyN迭代/缩放因子             |
+------------------------------------------------------------------------------+

[.gitignore] ==================================================================
| data/ | checkpoints/ | logs/ | __pycache__/ | .venv/ | *.nii.gz | *.pth    |
+------------------------------------------------------------------------------+
```

---

## 三、工程文件结构设计

```
DigitalTwinLung_COPD/
│
├── README.md                     # 项目说明书 (项目背景、安装步骤、运行方法)
├── requirements.txt              # 依赖库列表 (pip install -r requirements.txt)
├── config.yaml                   # [重要] 全局配置文件 (路径、阈值、超参数、数据契约)
├── .gitignore                    # [重要] Git 忽略规则文件
├── run_pipeline.py               # 一键运行全流程的入口脚本
├── Engineering_Edition.md        # 项目数据策略与工程实施指南
├── v5_1_Final.md                 # 研究课题评估与实施方案
│
├── data/                         # 【数据层】 (在 .gitignore 中忽略)
│   ├── 00_raw/                   # 原始下载数据 (只读，不动)
│   │   ├── normal/               # LIDC-IDRI 筛选出的正常人 DICOM/NIfTI
│   │   └── copd/                 # COPD 患者 DICOM/NIfTI
│   │
│   ├── 01_cleaned/               # 预处理后的纯净数据
│   │   ├── normal_clean/         # 仅含肺部，背景为 -1000
│   │   └── copd_clean/
│   │
│   ├── 02_atlas/                 # 标准数字孪生底座
│   │   ├── standard_template.nii.gz  # 最终生成的平均 CT
│   │   └── standard_mask.nii.gz      # 对应的肺部 Mask
│   │
│   ├── 03_mapped/                # 配准后的中间结果
│   │   └── patient_001/          # 按病人ID存放
│   │       ├── warped_lesion.nii.gz  # 变形到标准空间的病灶
│   │       └── transform.mat         # 变形场矩阵
│   │
│   └── 04_final_viz/             # 最终用于可视化的融合文件
│       ├── fused_copd_twin.nii.gz
│       └── renders/              # 渲染输出图片
│
├── checkpoints/                  # 【模型层】 训练模型权重 (在 .gitignore 中忽略)
│   ├── inpainting_best.pth       # 最佳模型权重
│   ├── inpainting_latest.pth     # 最新模型权重
│   └── training_log.json         # 训练历史记录
│
├── logs/                         # 【日志层】 运行日志 (在 .gitignore 中忽略)
│   ├── preprocessing_2025xxxx.log
│   ├── training_2025xxxx.log
│   └── pipeline.log              # 主流程日志
│
├── src/                          # 【代码层】 核心逻辑代码
│   ├── __init__.py
│   │
│   ├── utils/                    # 工具包 (复用函数)
│   │   ├── __init__.py
│   │   ├── io.py                 # 读取/保存 NIfTI, DICOM
│   │   ├── math_ops.py           # 归一化、裁剪、矩阵运算
│   │   ├── visualization.py      # PyVista 通用绘图函数
│   │   ├── logger.py             # 统一日志配置
│   │   ├── metrics.py            # 评估指标计算
│   │   ├── data_quality.py       # 数据质量检查
│   │   └── validation.py         # 配准结果验证与诊断
│   │
│   ├── 01_preprocessing/         # 阶段一：清洗与特征提取
│   │   ├── __init__.py
│   │   ├── run_segmentation.py   # 调用 TotalSegmentator
│   │   ├── clean_background.py   # 去除骨骼背景
│   │   └── extract_emphysema.py  # LAA-950 算法提取病灶 Mask
│   │
│   ├── 02_atlas_build/           # 阶段二：底座构建
│   │   ├── __init__.py
│   │   └── build_template_ants.py# 调用 ants.build_template
│   │
│   ├── 03_registration/          # 阶段三(上)：空间映射
│   │   ├── __init__.py
│   │   └── register_lesions.py   # 计算变形场并扭曲 Mask
│   │
│   ├── 04_texture_synthesis/     # 阶段三(下)：AI 纹理融合
│   │   ├── __init__.py
│   │   ├── dataset.py            # PyTorch 数据加载器 (提取 Patch)
│   │   ├── network.py            # 定义 GAN / Inpainting 模型结构
│   │   ├── losses.py             # 损失函数定义
│   │   ├── train.py              # 训练脚本
│   │   └── inference_fuse.py     # 推理脚本：生成融合后的 CT
│   │
│   └── 05_visualization/         # 阶段四：3D 可视化
│       ├── __init__.py
│       ├── static_render.py      # 生成高清截图
│       └── dynamic_breath.py     # 生成呼吸动画 (循环正弦波逻辑)
│
├── tests/                        # 【测试层】 单元测试与集成测试
│   ├── __init__.py
│   ├── conftest.py               # pytest 配置与 fixtures
│   ├── test_io.py                # 测试数据读写功能
│   ├── test_preprocessing.py     # 测试预处理流程
│   ├── test_registration.py      # 测试配准功能
│   ├── test_network.py           # 测试网络前向传播
│   ├── test_metrics.py           # 测试评估指标计算
│   └── test_data_quality.py      # 测试数据质量检查
│
├── notebooks/                    # 【实验层】 Jupyter Notebooks (用于探索和调试)
│   ├── 1.0_check_data.ipynb      # 检查数据质量
│   ├── 2.0_test_ants.ipynb       # 测试小样本配准参数
│   ├── 3.0_train_debug.ipynb     # AI 训练调试
│   └── 4.0_viz_demo.ipynb        # 快速查看可视化效果
│
└── docs/                         # 【文档层】
    ├── method_v5.1.md            # 保存的技术方案文档
    └── research_log.md           # 实验日志
```

---

## 四、使用说明

### 如何更新进度标记

1. **标记任务状态**
   - 当开始某个任务时，将 `[ ]` 修改为 `[~]`
   - 当完成某个任务时，将 `[~]` 修改为 `[x]`

2. **更新示例**
   ```
   # 任务未开始
   [ ] 环境配置

   # 任务进行中
   [~] 环境配置

   # 任务已完成
   [x] 环境配置
   ```

3. **阶段状态更新规则**
   - 当阶段内所有任务完成后，将阶段标记改为 `[x]`
   - 当阶段内有任务进行中，将阶段标记改为 `[~]`

4. **建议的更新频率**
   - 每次工作结束时更新进度
   - 每周至少更新一次
   - 遇到重要里程碑时及时更新

5. **版本控制**
   - 建议将此文件纳入 Git 版本控制
   - 每次更新后提交，便于追踪项目历史进度

---

*文档生成工具：Augment Agent*

